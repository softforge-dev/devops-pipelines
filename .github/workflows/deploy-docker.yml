name: Deploy Docker Compose (Reusable)

on:
  workflow_call:
    inputs:
      deploy_path:
        required: true
        type: string
    secrets:
      SSH_KEY:
        required: true
      SSH_USER:
        required: true
      SSH_HOST:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout projeto alvo
      uses: actions/checkout@v4

    # -------------------------
    # PREPARAR CHAVE SSH
    # -------------------------
    - name: Configurar chave SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

    # -------------------------
    # TESTAR CONEXÃO SSH (DEBUG)
    # -------------------------
    - name: Testar conexão SSH (DEBUG)
      run: |
        ssh -vvv -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'CONEXÃO OK'"

    # -------------------------
    # COPIAR APENAS PASTA docker/ COM DEBUG
    # -------------------------
    - name: Copiar docker/ para VPS (DEBUG)
      run: |
        rsync -avvz \
          -e "ssh -vvv -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./docker/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ inputs.deploy_path }}/docker/

    # -------------------------
    # RODAR DOCKER COMPOSE NO SERVIDOR
    # -------------------------
    - name: Rodar Docker Compose no servidor (DEBUG)
      run: |
        ssh -vvv -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "cd ${{ inputs.deploy_path }}/docker && \
           docker compose down && \
           docker compose up -d --build"
